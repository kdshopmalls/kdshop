<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/layout}">
  <th:block layout:fragment="script1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  </th:block>

  <th:block layout:fragment="content">
    <style>
      .messenger-container {
        width: 100%;
        max-width: 800px;
        height: 600px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        margin: 20px auto;
      }

      .messenger-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 20px;
        text-align: center;
        font-size: 18px;
        font-weight: 600;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .chat-area {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f0f8ff;
      }

      .message {
        margin-bottom: 15px;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        text-align: right;
      }

      .message-bubble {
        display: inline-block;
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
        line-height: 1.4;
      }

      .message.user .message-bubble {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border-bottom-right-radius: 4px;
      }

      .message.bot .message-bubble {
        background: white;
        color: #333;
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .input-area {
        padding: 15px 20px;
        background: white;
        border-top: 1px solid #e4e6eb;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      #question {
        flex: 1;
        border: 1px solid #e4e6eb;
        border-radius: 20px;
        padding: 10px 16px;
        font-size: 15px;
        font-family: inherit;
        resize: none;
        outline: none;
        max-height: 100px;
        transition: border-color 0.3s;
      }

      #question:focus {
        border-color: #4facfe;
      }

      #btn_chatbot_request {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s, box-shadow 0.2s;
        flex-shrink: 0;
      }

      #btn_chatbot_request:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
      }

      #btn_chatbot_request:active {
        transform: scale(0.95);
      }

      #btn_chatbot_request::before {
        content: "➤";
        font-size: 18px;
      }

      .chat-area::-webkit-scrollbar {
        width: 6px;
      }

      .chat-area::-webkit-scrollbar-track {
        background: transparent;
      }

      .chat-area::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
      }

      .typing-indicator {
        display: none;
        padding: 12px 16px;
        background: white;
        border-radius: 18px;
        width: fit-content;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .typing-indicator span {
        height: 8px;
        width: 8px;
        background: #4facfe;
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        animation: typing 1.4s infinite;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
        }
        30% {
          transform: translateY(-10px);
        }
      }
    </style>

    <div class="messenger-container">
      <div class="messenger-header">고객센터</div>

      <div class="chat-area" id="chatArea">
        <div class="message bot">
          <div class="message-bubble">안녕하세요! 무엇을 도와드릴까요?</div>
        </div>
      </div>

      <div class="input-area">
        <textarea id="question" rows="1" placeholder="메시지를 입력하세요"></textarea>
        <button type="button" id="btn_chatbot_request"></button>
      </div>
    </div>
  </th:block>

  <th:block layout:fragment="script2">
    <script>
      $(document).ready(function () {
        const chatArea = $("#chatArea");

        // 자동 스크롤
        function scrollToBottom() {
          chatArea.scrollTop(chatArea[0].scrollHeight);
        }

        // 메시지 추가 함수
        function addMessage(text, isUser) {
          const messageClass = isUser ? "user" : "bot";
          const messageHtml = `
            <div class="message ${messageClass}">
              <div class="message-bubble">${text}</div>
            </div>
          `;
          chatArea.append(messageHtml);
          scrollToBottom();
        }

        // 타이핑 인디케이터 표시
        function showTyping() {
          const typingHtml = `
            <div class="message bot typing-indicator" id="typing">
              <span></span><span></span><span></span>
            </div>
          `;
          chatArea.append(typingHtml);
          $("#typing").show();
          scrollToBottom();
        }

        function hideTyping() {
          $("#typing").remove();
        }

        // 엔터키로 전송
        $("#question").on("keypress", function (e) {
          if (e.which === 13 && !e.shiftKey) {
            e.preventDefault();
            $("#btn_chatbot_request").click();
          }
        });

        // 챗봇 요청
        $("#btn_chatbot_request").on("click", function () {
          const question = $("#question").val().trim();

          if (question === "") return;

          // 사용자 메시지 추가
          addMessage(question, true);
          $("#question").val("");

          // 타이핑 인디케이터 표시
          showTyping();

          // AJAX 요청
          $.ajax({
            url: "/chatapi/chat?question=" + encodeURIComponent(question),
            type: "get",
            dataType: "text",
            success: function (response) {
              hideTyping();
              addMessage(response, false);
            },
            error: function () {
              hideTyping();
              addMessage("죄송합니다. 다시 문의해주세요.", false);
            },
          });
        });

        scrollToBottom();
      });
    </script>
  </th:block>
</html>
